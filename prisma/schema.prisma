generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  TENANT
}

enum AuthProvider {
  EMAIL
  GOOGLE
  FACEBOOK
}

enum TokenType {
  EMAIL_VERIFY
  RESET_PASSWORD
}

enum BookingStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  PROCESSING
  CANCELLED
  COMPLETED
}

enum PriceAdjustmentType {
  PERCENTAGE
  NOMINAL
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  name          String
  phone         String?
  passwordHash  String?
  role          UserRole       @default(USER)
  provider      AuthProvider   @default(EMAIL)
  providerId    String?
  isVerified    Boolean        @default(false)
  avatarUrl     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenantProfile TenantProfile?
  tokens        UserToken[]
  bookings      Booking[]
  reviews       Review[]
}

model TenantProfile {
  id          Int        @id @default(autoincrement())
  userId      Int        @unique
  displayName String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties  Property[]
}

model UserToken {
  id         Int       @id @default(autoincrement())
  userId     Int
  type       TokenType
  token      String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("user_tokens")
}

model PropertyCategory {
  id         Int        @id @default(autoincrement())
  name       String     @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  properties Property[]
}

model Property {
  id           Int              @id @default(autoincrement())
  tenantId     Int
  categoryId   Int
  name         String
  slug         String           @unique
  description  String?
  addressLine1 String?
  city         String
  state        String?
  country      String           @default("Indonesia")
  postalCode   String?
  latitude     Decimal?         @db.Decimal(10, 7)
  longitude    Decimal?         @db.Decimal(10, 7)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  tenant       TenantProfile    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category     PropertyCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  rooms        Room[]
  images       PropertyImage[]
  bookings     Booking[]
  reviews      Review[]

  @@index([tenantId])
  @@index([categoryId])
}

model PropertyImage {
  id         Int      @id @default(autoincrement())
  propertyId Int
  url        String
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_images")
}

model Room {
  id               Int                   @id @default(autoincrement())
  propertyId       Int
  name             String
  description      String?
  capacity         Int
  totalUnits       Int                   @default(1)
  basePrice        Decimal               @db.Decimal(12, 2)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  property         Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  images           RoomImage[]
  availabilities   RoomAvailability[]
  priceAdjustments RoomPriceAdjustment[]
  bookings         Booking[]

  @@index([propertyId])
}

model RoomImage {
  id        Int     @id @default(autoincrement())
  roomId    Int
  url       String
  isPrimary Boolean @default(false)
  room      Room    @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@map("room_images")
}

model RoomAvailability {
  id             Int      @id @default(autoincrement())
  roomId         Int
  date           DateTime
  isAvailable    Boolean  @default(true)
  availableUnits Int?
  note           String?
  createdAt      DateTime @default(now())
  room           Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, date])
  @@index([date])
  @@map("room_availabilities")
}

model RoomPriceAdjustment {
  id        Int                 @id @default(autoincrement())
  roomId    Int
  startDate DateTime
  endDate   DateTime
  type      PriceAdjustmentType
  value     Decimal             @db.Decimal(10, 2)
  note      String?
  createdAt DateTime            @default(now())
  room      Room                @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([startDate, endDate])
  @@map("room_price_adjustments")
}

model Booking {
  id           Int           @id @default(autoincrement())
  userId       Int
  propertyId   Int
  roomId       Int
  checkIn      DateTime
  checkOut     DateTime
  guests       Int
  status       BookingStatus @default(WAITING_PAYMENT)
  paymentDueAt DateTime
  totalAmount  Decimal       @db.Decimal(14, 2)
  currency     String        @default("IDR")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  property     Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  room         Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  paymentProof PaymentProof?
  review       Review?

  @@index([userId, status])
  @@index([propertyId])
  @@index([roomId, checkIn, checkOut])
  @@map("bookings")
}

model PaymentProof {
  id         Int       @id @default(autoincrement())
  bookingId  Int       @unique
  fileUrl    String
  fileName   String
  mimeType   String
  uploadedAt DateTime  @default(now())
  verifiedAt DateTime?
  booking    Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payment_proofs")
}

model Review {
  id          Int       @id @default(autoincrement())
  bookingId   Int       @unique
  propertyId  Int
  userId      Int
  comment     String
  rating      Int?
  tenantReply String?
  repliedAt   DateTime?
  createdAt   DateTime  @default(now())
  booking     Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([userId])
  @@map("reviews")
}
